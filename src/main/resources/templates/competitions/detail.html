<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<style>
    .table-center {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .table-width {
        max-width: 1000px;
    }
    .tournament {
        display: flex;
        justify-content: center;
    }

    .round {
        width: 200px;
        float: left;
    }

    .match {
        width: 200px;
        height: 60px;
        border: 3px solid black;
        margin: 10px 0;
        background: gray;
        color: white;
        padding: 3px 3px 3px 6px;
    }

    .hidden {
        visibility: hidden;
    }

    .player {
        font-family:arial;
        width:120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color:white;
        float: left;
        text-align: center;
    }

    .score {
        font-family:arial;
        width:50px;
        color:white;
        float: right;
        text-align: center;
    }

    .round5 .match {
        margin-top: 1090px;
    }

    .round4 .match {
        margin-top: 1060px;
    }

    .round4 .match:first-child {
        margin-top: 530px;
    }

    .round3 .match {
        margin-top: 500px;
    }

    .round3 .match:first-child {
        margin-top: 250px;
    }
    .round2 .match {
        margin-top: 220px;
    }
    .round2 .match:first-child {
        margin-top: 110px;
    }
    .round1 .match {
        margin-top: 80px;
    }
    .round1 .match:first-child {
        margin-top: 40px;
    }
    .round0 .match {
        margin-top: 10px;
    }
    .round0 .match:first-child {
        margin-top: 5px;
    }

    .line {
        width: 40px;
        float: left;
    }

    .line div {
        border-top: 3px solid black;
    }

    .line div:first-child {
        margin-top: 200px;
    }

    #line4 div {
        margin-top: 1120px;
    }

    #line3 div {
        margin-top: 1115px;
    }

    #line3 div:first-child {
        margin-top: 560px;
    }

    #line2 div {
        margin-top: 557px;
    }

    #line2 div:first-child {
        margin-top: 277px;
    }

    #line1 div {
        margin-top: 277px;
    }

    #line1 div:first-child {
        margin-top: 138px;
    }

    #line0 div {
        margin-top: 137px;
    }

    #line0 div:first-child {
        margin-top: 70px;
    }

    .connector {
        width: 50px;
        float: left;
    }

    .connector div {
        border: 3px solid black;
        border-left: none;
        border-bottom: none;
        height: 50px;
        width: 50px;
        /*margin-left: 25px;*/
    }

    #conn4 div {
        margin-top: 560px;
        height: 560px;
    }

    #conn4 div:first-child {
        margin-top: 558px;
    }

    #conn3 div {
        margin-top: 280px;
        height: 280px;
    }

    #conn3 div:first-child {
        margin-top: 280px;
    }

    #conn2 div {
        margin-top: 140px;
        height: 140px;
    }

    #conn2 div:first-child {
        margin-top: 139px;
    }

    #conn1 div {
        margin-top: 70px;
        height: 70px;
    }

    #conn1 div:first-child {
        margin-top: 70px;
    }

    #conn0 div {
        margin-top: 35px;
        height: 35px;
    }

    #conn0 div:first-child {
        margin-top: 37px;
    }
</style>
<body>
<div>
    <div th:replace="fragments/bodyheader" :: bodyheader />
    <hr class="my-4">
    <div class="table-center">
        <table class="table table-striped table-width text-center">
            <thead>
            <tr>
                <th>대회명</th>
                <th>대회방식</th>
                <th>참여자수</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td th:text="${competition.title}"></td>
                <td th:text="${competition.competitionType}"></td>
                <td th:text="${joins.size()}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="">
        <a th:href="@{|/rooms/${roomId}|}" class="btn btn-warning">목록</a>
        <a class="btn btn-secondary my-2 my-sm-0" th:if="${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}"
           th:href="@{|/rooms/${roomId}/competitions/${competitionId}/edit|}">수정</a>
        <form class="form-check-inline my-2 my-lg-0" th:action="@{|/rooms/${roomId}/competitions/${competitionId}|}" method="post">
            <input type="hidden" th:if="${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}" name="_method" value="delete"/>
            <button class="btn btn-danger my-2 my-sm-0" type="submit"
                    th:if="${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}">삭제</button>
        </form>
    </div>

    <!--<h1>대회참여자</h1>
    <table class="table table-light">
        <tbody>
        <tr th:each="join : ${joins}">
            <td th:text="|${join.member.email}(${join.member.name})|"></td>
        </tr>
        </tbody>
    </table>-->

    <hr class="my-4">
    <h1>일정</h1>
    <div th:if="${competition.competitionType.name() == 'LEAGUE'}">
        <div class="table-center">
            <table class="table table-bordered table-width text-center">
                <tbody th:each="key : ${hashMap.keySet()}">
                <tr>
                    <td th:text="|${key + 1}라운드|"></td>
                    <td>
                        <table class="table table-bordered">
                            <tbody th:each="k : ${hashMap.get(key).keySet()}" th:with="match=${hashMap.get(key).get(k)}">
                            <tr>
                                <td th:text="|${match.home.email}(${match.home.name})|">홈팀명</td>
                                <td th:text="|${match.score.homeScore}:${match.score.awayScore}|">스코어</td>
                                <td th:text="|${match.away.email}(${match.away.name})|">어웨이팀명</td>
                                <td>
                                    <a class="btn btn-primary"
                                       th:if="${match.home != null} and ${match.away != null}
                                       and ${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}"
                                       th:href="@{|/rooms/${roomId}/competitions/${competitionId}/matches/${match.id}/update|}">수정</a>
                                    <a class="btn btn-primary"
                                       th:if="${match.home != null} and ${match.away != null} and ${match.matchStatus.name() eq 'END'}
                                       and ${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}"
                                       th:href="'javascript:init('+${roomId}+', '+${competitionId}+', '+${match.id}+')'">초기화</a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <hr class="my-4">
        <h1>순위</h1>
        <div class="table-center">
            <table class="table table-light table-width text-center">
                <thead>
                <tr>
                    <th>#</th>
                    <th>회원명</th>
                    <th>경기수</th>
                    <th>승</th>
                    <th>무</th>
                    <th>패</th>
                    <th>승점</th>
                    <th>득점</th>
                    <th>실점</th>
                    <th>득실차</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="join : ${joins}">
                    <td th:text="${joinStat.count}"></td>
                    <td th:text="|${join.member.email}(${join.member.name})|"></td>
                    <td th:text="${join.result.win} + ${join.result.draw} + ${join.result.lose}"></td>
                    <td th:text="${join.result.win}"></td>
                    <td th:text="${join.result.draw}"></td>
                    <td th:text="${join.result.lose}"></td>
                    <td th:text="${join.result.win * 3} + ${join.result.draw}"></td>
                    <td th:text="${join.result.goalFor}"></td>
                    <td th:text="${join.result.goalAgainst}"></td>
                    <td th:text="${join.result.goalFor} - ${join.result.goalAgainst}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="tournament" th:if="${competition.competitionType.name() == 'TOURNAMENT'}">
        <div th:each="key : ${#numbers.sequence(T(java.util.Collections).max(hashMap.keySet()), 0, -1)}"
             th:with="cnt=${T(java.lang.Math).pow(2, key)}">
            <div class="round" th:classappend="|round${keyStat.index}|">
                <div th:each="k : ${#numbers.sequence(0, cnt - 1, 1)}" th:with="match=${hashMap.get(key).get(k)}"
                     class="match" th:classappend="${match == null} ? 'hidden'">
                    <div th:if="${match != null}">
                        <div class="player" th:text="${match.home == null} ? |${keyStat.index}-${k * 2 + 1}경기 승자|: |${match.home.email}(${match.home.name})|">home</div>
                        <div class="score" th:text="${match.score.homeScore}">0</div>
                        <div class="player" th:text="${match.away == null} ? |${keyStat.index}-${k * 2 + 2}경기 승자|: |${match.away.email}(${match.away.name})|">away</div>
                        <div class="score" th:text="${match.score.awayScore}">0</div>
                        <a class="btn btn-primary"
                           th:if="${match.home != null} and ${match.away != null} and ${myBelong ne null and (myBelong.belongType.name() eq 'ADMIN')}"
                           th:href="@{|/rooms/${roomId}/competitions/${competitionId}/matches/${match.id}/update|}">수정</a>
                    </div>
                </div>
            </div>

            <div class="connector" th:id="|conn${keyStat.index}|">
                <div th:each="k: ${#numbers.sequence(0, cnt - 1, 1)}"
                     th:classappend="${hashMap.get(key).get(k) == null} ? 'hidden'"></div>
            </div>

            <div class="line" th:id="|line${keyStat.index}|">
                <div th:each="k: ${#numbers.sequence(0, (cnt / 2) - 1, 1)}"
                     th:classappend="${hashMap.get(key).get(k * 2) == null and hashMap.get(key).get(k * 2 + 1) == null} ? 'hidden'"></div>
            </div>
        </div>
    </div>
    <div th:replace="fragments/footer" :: footer />
</div> <!-- /container -->
</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
    $(function(){
        $('button').css('background-color', 'red');
    });
</script>
<script>
    function init(roomId, competitionId, matchId) {
        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/rooms/" + roomId + "/competitions/" + competitionId + "/matches/" + matchId + "/init");
        document.body.appendChild(form);
        form.submit();
    }
</script>
</html>
